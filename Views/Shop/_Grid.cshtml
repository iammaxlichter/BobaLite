@model List<BobaLite.Models.Product>
@{
    const int lowThreshold = 10;
}

<section class="product-grid">
  @foreach (var product in Model)
  {
    // slug for image URLs
    var slug = product.Name
      .ToLowerInvariant()
      .Replace(" ", "-")
      .Replace("--", "-");

    // build a list of (variant, packSize) and order by packSize
    var packs = product.Variants
      .Select(v => new {
        Variant = v,
        PackSize = int.Parse(v.Attributes.Split('-')[0])
      })
      .OrderBy(x => x.PackSize)
      .ToList();

    // use the 1-pack as initial state (or first if no 1-pack)
    var first = packs.FirstOrDefault(x => x.PackSize == 1) ?? packs.First();
    var stock1 = first.Variant.Stock;

    // decide card-level classes/text
    var cardClass = stock1 == 0
      ? "out-of-stock"
      : (stock1 <= lowThreshold ? "low-stock" : "");

    var labelText = stock1 == 0
      ? "Out of Stock"
      : (stock1 <= lowThreshold 
         ? $"Low stock: {stock1} left"
         : "");
  <div class="product-card @cardClass" data-slug="@slug">
    @* banner *@
    @if (!string.IsNullOrEmpty(labelText))
    {
      <div class="stock-label">@labelText</div>
    }

    @* cart button *@
    <button
      class="add-cart-icon"
      aria-label="Add to Cart"
      data-pack="@first.PackSize"
      disabled="@(stock1 == 0 ? "disabled" : null)"
    >
      <img
        src="@Url.Content($"~/images/Shop/shopping-cart-plus.png")"
        data-plus="@Url.Content($"~/images/Shop/shopping-cart-plus.png")"
        data-check="@Url.Content($"~/images/Shop/shopping-cart-check.png")"
        alt="Add to cart"
      />
    </button>

    @* main image *@
    <img
      class="can-image"
      src="@Url.Content($"~/images/Shop/{slug}-{first.PackSize}-pack.png")"
      alt="@product.Name"
    />

    <h3>@product.Name</h3>
    <p class="price">
      @first.PackSize Pack â€“ $@first.Variant.Price.ToString("F2")
    </p>

    <div class="pack-options">
      @foreach (var entry in packs)
      {
        var v    = entry.Variant;
        var ps   = entry.PackSize;
        var is0  = v.Stock == 0;
        <button
          class="pack-btn @(ps == first.PackSize ? "active" : "")"
          data-pack="@ps"
          data-price="@v.Price.ToString("F2")"
          data-stock="@v.Stock"
          disabled="@(is0 ? "disabled" : null)"
        >
          @ps
        </button>
      }
    </div>
  </div>
  }
</section>

@section Scripts {
  <script type="module" src="~/js/Shop/pack-switcher.js"></script>
}
